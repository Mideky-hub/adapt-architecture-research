<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>readme</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="README_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="README_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="design-and-development-of-cloud-based-microservice-architecture-for-resilient-performant-and-scalable-applications-using-adapt-design-patterns" class="level1">
<h1>Design and Development of cloud-based microservice architecture for resilient, performant and scalable applications using ADAPT Design Patterns</h1>
<p>Mr.&nbsp;Mathieu KERBEL</p>
<p>Senior Software Engineer &amp; Cloud Solutions Architect Creator of the ADAPT Architecture Principle Paris, Île-de-France, France mathieukerbel@gmail.com</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://github.com/Mideky-hub/adapt-architecture-principle/"><img src="https://img.shields.io/badge/Architecture-ADAPT-blueviolet.png" class="img-fluid figure-img"></a></p>
<figcaption>ADAPT Architecture</figcaption>
</figure>
</div>
<section id="abstract" class="level2">
<h2 class="anchored" data-anchor-id="abstract">Abstract</h2>
<p>Microservices have revolutionized software architecture by promoting modularity, scalability, interoperability and resilience. However, traditional design principles like SOLID have shown limitations in addressing the complexities of microservices architectures, more particularly in cloud-based environments. This research paper explores the application of the ADAPT (Asynchronous, Domain-distributed, Abstraction-moderated, Piloted through events, Transparent and observable) architecture principles and design patterns to develop a robust microservices architecture for cloud-based applications.</p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The history of software architecture is continous struggl against entropy and complexity. As applications grow in size and functionality, the era of monolithic architectures with the logical architecture (how the code is organized) and thge physical architecture (how the code is deployed) tightly coupled together has shown its limitations. Microservices architecture emerged as a solution to these challenges, offering a way to break down applications into smaller, independent services that can be developed, deployed, and scaled independently.</p>
<p>If the SOLID principles</p>
<p>/// continue once results has been achieved.</p>
</section>
<section id="literature-review" class="level2">
<h2 class="anchored" data-anchor-id="literature-review">Literature Review</h2>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<section id="event-driven-architecture-and-dx-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="event-driven-architecture-and-dx-based-approach">Event-Driven Architecture and DX-based approach</h3>
</section>
<section id="adapt-principles-and-design-patterns" class="level3">
<h3 class="anchored" data-anchor-id="adapt-principles-and-design-patterns">ADAPT Principles and Design Patterns</h3>
<section id="asynchronous-communication" class="level4">
<h4 class="anchored" data-anchor-id="asynchronous-communication">Asynchronous Communication</h4>
<blockquote class="blockquote">
<p>“Services must be decoupled, communicating through events rather than direct calls to build resilient and scalable systems.”</p>
</blockquote>
<p>First principle of ADAPT architecture [1][2] focuses on asynchronous communication between microservices to enhance scalability and resilience. This section explores various asynchronous communication patterns such as message queues, event streaming, and publish–subscribe models.</p>
<section id="message-queues-event-streaming-and-publishsubscribe-models-using-apache-kafka" class="level5">
<h5 class="anchored" data-anchor-id="message-queues-event-streaming-and-publishsubscribe-models-using-apache-kafka">Message queues, event streaming, and publish–subscribe models using Apache Kafka</h5>
<p>Kafka is a distributed event streaming platform that enables asynchronous communication between microservices. It allows services to publish and subscribe to streams of records, facilitating decoupled interactions. As there are multiple ways to manage message queues, Kafka is one of the most popular solutions for building event-driven architectures, therefore it is used as an example in this section.</p>
<div data-align="center">
<img src="cluster_kafka_uml.png" alt="Kafka Cluster in a Emitting and Receiving System Component" width="600">
<figcaption align="center">
<i>Figure 1: Kafka Cluster in an Emitting and Receiving System Component</i>
</figcaption>
</div>
<p>A few rikes can benefit from using Kafka in microservices architecture include :</p>
<ul>
<li><p><strong>Decoupling services</strong>: Kafka allows services to communicate without direct dependencies, enhancing flexibility and maintainability.</p></li>
<li><p><strong>Scalability</strong>: Kafka’s distributed architecture supports high throughput and can handle large volumes of data, its axis of scalability is horizontal due to its distributed nature. As data expand across multiple brokers, Kafka can efficiently manage increased loads by adding more brokers to the cluster.</p></li>
<li><p><strong>Resilience &amp; Fault Tolerance</strong>: Kafka’s fault-tolerant design ensures that messages are not lost, even in the event of service failures. It achieves this through data replication across multiple brokers and automatic failover mechanisms.</p></li>
<li><p><strong>Real-time Data Processing</strong>: Kafka enables real-time data streaming and processing, which is essential for applications requiring immediate insights and actions.</p></li>
<li><p><strong>Event Sourcing</strong>: Kafka can be used to implement event sourcing patterns, where state changes are logged as a sequence of events, allowing for better traceability and recovery.</p></li>
</ul>
</section>
</section>
<section id="domain-distributed-driven-design" class="level4">
<h4 class="anchored" data-anchor-id="domain-distributed-driven-design">Domain-Distributed-Driven Design</h4>
<blockquote class="blockquote">
<p>“The architecture must mirror the business domain, with services organized around business capabilities, not technical layers.”</p>
</blockquote>
<p>The second principle of ADAPT architecture [1][2] emphasizes the importance of aligning microservices with business domains. This section discusses Domain-Driven Design (DDD) concepts such as bounded contexts, aggregates, and domain events to structure services around business capabilities.</p>
<p>The ADAPT principle redefines the single responsibility principle from SOLID with a business capability having the complete ownership of its data and logic within a bounded context. This approach ensures that each microservice is responsible for a specific business function, avoinding some common pitfalls of microservices that going against the atomicity of business capabilities.</p>
</section>
<section id="abstraction-moderation" class="level4">
<h4 class="anchored" data-anchor-id="abstraction-moderation">Abstraction Moderation</h4>
</section>
<section id="piloted-through-events-and-configurations" class="level4">
<h4 class="anchored" data-anchor-id="piloted-through-events-and-configurations">Piloted through Events and Configurations</h4>
</section>
<section id="transparency-and-observability-through-contacts" class="level4">
<h4 class="anchored" data-anchor-id="transparency-and-observability-through-contacts">Transparency and Observability through Contacts</h4>
</section>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
</section>
<section id="case-study-e-commerce-application" class="level3">
<h3 class="anchored" data-anchor-id="case-study-e-commerce-application">Case Study: E-commerce Application</h3>
<p>To demonstrate the practical application of the ADAPT principles, this chapter details the migration of a reference legacy system to a cloud-based microservices architecture using ADAPT design patterns.</p>
<section id="system-architecture" class="level4">
<h4 class="anchored" data-anchor-id="system-architecture">System Architecture</h4>
<p>The current baseline architecture of the e-commerce application is structured as a typical legacy e-commerce application with a <strong><em>layered architecture</em></strong> with a <strong>Controller Layer</strong>, <strong>Service Layer</strong> and a <strong>Repository Layer</strong>. The application is <em>monolithic</em>, with all components <strong><em>tightly coupled</em></strong> together.</p>
</section>
<section id="technology-stack" class="level4">
<h4 class="anchored" data-anchor-id="technology-stack">Technology Stack</h4>
<p>The technical stack includes a relational database (<em>PostgreSQL</em>), a backend developed in <em>Java</em> with <em>Spring Boot</em> framework. The current service coupling is high, the <strong>Order Service</strong> has compile-time dependencies on the <strong>Inventory Service</strong> and the <strong>Payment Service</strong>. The Data is managed through a single database schema shared across all services with the <strong>Billing Service</strong> directly accessing the <strong>User Service</strong> database tables.</p>
</section>
<section id="benchmarking" class="level4">
<h4 class="anchored" data-anchor-id="benchmarking">Benchmarking</h4>
<p>The validity of the ADAPT Architecture Principles and Design Patterns is assessed using a suite of quantitative metrics derived from recent software engineering litterature. Those metrics replace vague notions of “clean code” and “clean architecture” with measurable criteria and structural attributes.</p>
<section id="what-to-measure" class="level5">
<h5 class="anchored" data-anchor-id="what-to-measure">What to measure?</h5>
<p>Derived from Panichella et al.&nbsp;(2021) [15], the structural coupling measures the senity of dependencies between microservices. Lower coupling values indicate better modularity and independence among services. It calcultaed as follows:</p>
<p><span class="math display">\[
SC(s_i) = \frac{\sum_{j \in S; j \not= i} dep(s_i, s_j)}{|S|}
\]</span></p>
<p>Where <span class="math inline">\(dep(s_i, s_j)\)</span> indicated a dependency from service <span class="math inline">\(i\)</span> to service <span class="math inline">\(j\)</span>, and <span class="math inline">\(|S|\)</span> is the total number of services in the system. If <span class="math inline">\(SC(s_i) = n\)</span> , it means that service <span class="math inline">\(s_i\)</span> depends on <span class="math inline">\(n\)</span> other services.</p>
<p>With microservices architectures, when our services are too granular and too many, there’s a nano-service anti-pattern that can appear, we can measure the Weighted Service Interface Count (WSIC) and the Service Interface Data Cohesion (SIDC).</p>
<p>The WSIC metric [20] measures API surface area and number of interfaces a service exposes, weighted by their complexity.</p>
<p>The SIDC is the metric that quantifie the cohesion of a service based on the cohesiveness of the operations exposed in its interface. It’s calculated as follows:</p>
<p><span class="math display">\[
\begin{aligned}
S &amp;= \operatorname{SOp}(si_s)=\{o_1,\dots,o_n\},\quad n=|S|.\\
\text{For }1\le i&lt;j\le n:&amp;\\
\quad I_{\mathrm{param}}(o_i,o_j)&amp;=
\begin{cases}
1,&amp; \operatorname{ParamTypes}(o_i)\cap\operatorname{ParamTypes}(o_j)\neq\varnothing,\\
0,&amp;\text{otherwise},
\end{cases}\\
\quad I_{\mathrm{ret}}(o_i,o_j)&amp;=
\begin{cases}
1,&amp; \operatorname{Ret}(o_i)=\operatorname{Ret}(o_j),\\
0,&amp;\text{otherwise}.
\end{cases}\\
P &amp;= \binom{n}{2}\quad(\text{number of unordered operation pairs}).\\
\text{Then}\qquad SIDC(s) &amp;=
\begin{cases}
\displaystyle\frac{\sum_{1\le i&lt;j\le n}\big(I_{\mathrm{param}}(o_i,o_j)+I_{\mathrm{ret}}(o_i,o_j)\big)}{2P}, &amp; P&gt;0,\\[8pt]
0, &amp; P=0.
\end{cases}
\end{aligned}
\]</span></p>
</section>
</section>
<section id="performance-testing" class="level4">
<h4 class="anchored" data-anchor-id="performance-testing">Performance Testing</h4>
</section>
</section>
</section>
<section id="results-and-discussion" class="level2">
<h2 class="anchored" data-anchor-id="results-and-discussion">Results and Discussion</h2>
<section id="scalability" class="level3">
<h3 class="anchored" data-anchor-id="scalability">Scalability</h3>
</section>
<section id="resilience" class="level3">
<h3 class="anchored" data-anchor-id="resilience">Resilience</h3>
</section>
<section id="performance" class="level3">
<h3 class="anchored" data-anchor-id="performance">Performance</h3>
</section>
<section id="maintainability" class="level3">
<h3 class="anchored" data-anchor-id="maintainability">Maintainability</h3>
</section>
<section id="developer-experience" class="level3">
<h3 class="anchored" data-anchor-id="developer-experience">Developer Experience</h3>
</section>
<section id="future-work" class="level3">
<h3 class="anchored" data-anchor-id="future-work">Future Work</h3>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<section id="acknowledgements" class="level3">
<h3 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h3>
</section>
<section id="weaknesses" class="level3">
<h3 class="anchored" data-anchor-id="weaknesses">Weaknesses</h3>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>[1] Kerbel, M. (2025). SOLID is killing the micro-services industry — ADAPT saves it. Medium. https://mathieukerbel.medium.com/solid-is-killing-the-micro-services-industry-adapt-saves-it-7f3f5f4f4f4f</p>
<p>[2] Kerbel, M. (2025). The ADAPT Architecture Manifesto. GitHub. https://github.com/Mideky-hub/adapt-architecture-principle/blob/main/README.md</p>
<p>[3] Rasheedh, J. A., &amp; Saradha, S. (2022). Design and Development of Resilient Microservices Architecture for Cloud Based Applications Using Hybrid Design Patterns. Indian Journal of Computer Science and Engineering, 13(2), 365–378. PDF: https://www.researchgate.net/profile/J-Rasheedh/publication/360132110_Design_and_Development_of_Resilient_Microservices_Architecture_for_Cloud_Based_Applications_using_Hybrid_Design_Patterns/links/6275381eb1ad9f66c8a72ce1/Design-and-Development-of-Resilient-Microservices-Architecture-for-Cloud-Based-Applications-using-Hybrid-Design-Patterns.pdf</p>
<p>[4] Bailo, D., Jeffery, K. G., Spinuso, A., &amp; Fiameni, G. (2015). Interoperability Oriented Architecture: The Approach of EPOS for Solid Earth e-Infrastructures. In 2015 IEEE 11th International Conference on e-Science, Munich, Germany. doi:10.1109/eScience.2015.22</p>
<p>[5] Di Francesco, P., Lago, P., &amp; Malavolta, I. (2019). Architecting with microservices: A systematic mapping study. Journal of Systems and Software, 150, 77–97.</p>
<p>[6] Balalaie, A., Heydarnoori, A., &amp; Jamshidi, P. (2016). Microservices architecture enables DevOps: Migration to a cloud-native architecture. IEEE Software, 33(3), 42–52.</p>
<p>[7] Newman, S. (2015). Building Microservices: Designing Fine-Grained Systems. O’Reilly Media.</p>
<p>[8] Taibi, D., Lenarduzzi, V., &amp; Pahl, C. (2020). Microservices Anti-patterns: A Taxonomy. In Microservices (pp.&nbsp;111–128). Springer, Cham.</p>
<p>[9] Soldani, J., Tamburri, D. A., &amp; Van Den Heuvel, W. J. (2018). The pains and gains of microservices: A systematic grey literature review. Journal of Systems and Software, 146, 215–232.</p>
<p>[10] Márquez, G., &amp; Astudillo, H. (2018). Actual use of architectural patterns in microservices-based open source projects. In 2018 25th Asia-Pacific Software Engineering Conference (APSEC) (pp.&nbsp;31–40). IEEE.</p>
<p>[11] Lewis, J., &amp; Fowler, M. (2014). Microservices — A definition of this new architectural term. martinfowler.com. https://martinfowler.com/articles/microservices.html</p>
<p>[12] Ibryam, B., &amp; Huß, R. (2023). Kubernetes Patterns: Reusable Elements for Designing Cloud-Native Applications (2nd ed.). O’Reilly Media.</p>
<p>[13] Burns, B. (2018). Designing Distributed Systems: Patterns and Paradigms for Scalable, Reliable Services. O’Reilly Media.</p>
<p>[14] Ponugoti, M. (2025). Cloud-Native Platform Engineering: Scalable Design Patterns for Global Enterprise Resilience. Journal of Computer Science and Technology Studies, 7(8), 48–59.</p>
<p>[15] Panichella, S., Rahman, M.I., &amp; Taibi, D. (2021). Structural Coupling for Microservices. International Conference on Cloud Computing and Services Science.</p>
<p>[16] Merson, P. (2020). Principles for microservice design: Think IDEALS, rather than SOLID. InfoQ. https://www.infoq.com/articles/microservices-design-ideals/</p>
<p>[17] Martin, R. C. (2017). Clean Architecture: A Craftsman’s Guide to Software Structure and Design. Prentice Hall.</p>
<p>[18] Millett, S., &amp; Tune, N. (2015). Patterns, Principles, and Practices of Domain-Driven Design. Wrox.</p>
<p>[19] Richardson, C. (2019). Pattern: API Gateway. microservices.io. https://microservices.io/patterns/apigateway.html</p>
<p>[20] Restful-ma, C. (2019). Weighted Service Interface Count (WSIC). https://github.com/restful-ma/rama-cli/blob/master/docs/metrics/WeightedServiceInterfaceCount.md</p>
<p>[21] Mateus Gabi Moreira and Breno Bernard Nicolau De França. 2022. Analysis of Microservice Evolution using Cohesion Metrics. In Proceedings of the 16th Brazilian Symposium on Software Components, Architectures, and Reuse (SBCARS ’22). Association for Computing Machinery, New York, NY, USA, 40–49. https://doi.org/10.1145/3559712.3559716</p>
<p>[22] Yiming Z., Tiziano D. M., &amp; Justus B. (2025). How Does Microservice Granularity Impact Energy Consumption and Performance? A Controlled Experiment. https://arxiv.org/html/2502.00482v1</p>
<p>[23] Hirzalla, M., Cleland-Huang, J., Arsanjani, A. (2009). A Metrics Suite for Evaluating Flexibility and Complexity in Service Oriented Architectures. In: Feuerlicht, G., Lamersdorf, W. (eds) Service-Oriented Computing – ICSOC 2008 Workshops. ICSOC 2008. Lecture Notes in Computer Science, vol 5472. Springer, Berlin, Heidelberg. https://doi.org/10.1007/978-3-642-01247-1_5</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>